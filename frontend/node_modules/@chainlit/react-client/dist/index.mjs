import { atom, selector, DefaultValue, useRecoilValue, useResetRecoilState, useSetRecoilState, useRecoilState } from 'recoil';
import z from 'lodash/isEqual';
import { v4 } from 'uuid';
import { useCallback, useEffect } from 'react';
import Dt from 'lodash/debounce';
import vt from 'socket.io-client';
export { Socket } from 'socket.io-client';
import Ut from 'jwt-decode';
import _t from 'swr';

var ut=i=>{let t={},e=new Date,s=new Date;s.setDate(e.getDate()-1);let n=new Date;n.setDate(e.getDate()-7);let o=new Date;return o.setDate(e.getDate()-30),i.forEach(a=>{let d=new Date(a.createdAt),p=d.toDateString()===e.toDateString(),h=d.toDateString()===s.toDateString(),f=d>=n,I=d>=o,g;p?g="Today":h?g="Yesterday":f?g="Previous 7 days":I?g="Previous 30 days":g=d.toLocaleString("default",{month:"long",year:"numeric"}).split(" ").slice(0,1).join(" "),t[g]||(t[g]=[]),t[g].push(a);}),t};var q=atom({key:"ThreadIdToResume",default:void 0}),gt=atom({key:"ChatProfile",default:void 0}),dt=atom({key:"SessionId",default:v4()}),H=selector({key:"SessionIdSelector",get:({get:i})=>i(dt),set:({set:i},t)=>i(dt,t instanceof DefaultValue?v4():t)}),C=atom({key:"Session",dangerouslyAllowMutability:!0,default:void 0}),D=atom({key:"Actions",default:[]}),M=atom({key:"Messages",dangerouslyAllowMutability:!0,default:[]}),W=atom({key:"TokenCount",default:0}),v=atom({key:"Loading",default:!1}),R=atom({key:"AskUser",default:void 0}),E=atom({key:"ChatSettings",default:[]}),st=selector({key:"ChatSettingsValue/Default",get:({get:i})=>i(E).reduce((e,s)=>(e[s.id]=s.initial,e),{})}),_=atom({key:"ChatSettingsValue",default:st}),w=atom({key:"DisplayElements",default:[]}),U=atom({key:"AvatarElements",default:[]}),F=atom({key:"TasklistElements",default:[]}),L=atom({key:"FirstUserMessage",default:void 0}),j=atom({key:"AccessToken",default:void 0}),ht=atom({key:"User",default:null}),mt=atom({key:"ThreadHistory",default:{threads:void 0,currentThreadId:void 0,timeGroupedThreads:void 0,pageInfo:void 0},effects:[({setSelf:i,onSet:t})=>{t((e,s)=>{let n=e?.timeGroupedThreads;e?.threads&&!z(e.threads,s?.timeGroupedThreads)&&(n=ut(e.threads)),i({...e,timeGroupedThreads:n});});}]});var Wt=()=>{let i=useRecoilValue(v),t=useRecoilValue(w),e=useRecoilValue(U),s=useRecoilValue(F),n=useRecoilValue(D),o=useRecoilValue(C),a=useRecoilValue(R),d=useRecoilValue(E),p=useRecoilValue(_),h=useRecoilValue(st),f=o?.socket.connected&&!o?.error,I=!f||i||a?.spec.type==="file"||a?.spec.type==="action";return {actions:n,askUser:a,avatars:e,chatSettingsDefaultValue:h,chatSettingsInputs:d,chatSettingsValue:p,connected:f,disabled:I,elements:t,error:o?.error,loading:i,tasklists:s}};var Xt=i=>{let t=[];for(let e of i)t=A(t,e);return t},Yt=(i,t)=>{if(i.length-1===t)return !0;for(let e=t+1;e<i.length;e++)if(!i[e].streaming)return !1;return !0},A=(i,t)=>V(i,t.id)?N(i,t.id,t):"parentId"in t&&t.parentId?It(i,t.parentId,t):"indent"in t&&t.indent&&t.indent>0?St(i,t.indent,t):[...i,t],St=(i,t,e,s=0)=>{let n=[...i];if(n.length===0)return [...n,e];{let o=n.length-1,a=n[o];return a.steps=a.steps||[],s+1===t?(a.steps=[...a.steps,e],n[o]={...a},n):(a.steps=St(a.steps,t,e,s+1),n[o]={...a},n)}},It=(i,t,e)=>{let s=[...i];for(let n=0;n<s.length;n++){let o=s[n];z(o.id,t)?(o.steps=o.steps?[...o.steps,e]:[e],s[n]={...o}):V(s,t)&&o.steps&&(o.steps=It(o.steps,t,e),s[n]={...o});}return s},V=(i,t)=>{for(let e of i){if(z(e.id,t))return !0;if(e.steps&&e.steps.length>0&&V(e.steps,t))return !0}return !1},N=(i,t,e)=>{let s=[...i];for(let n=0;n<s.length;n++){let o=s[n];z(o.id,t)?s[n]={steps:o.steps,...e}:V(s,t)&&o.steps&&(o.steps=N(o.steps,t,e),s[n]={...o});}return s},nt=(i,t)=>{let e=[...i];for(let s=0;s<e.length;s++){let n=e[s];n.id===t?e=[...e.slice(0,s),...e.slice(s+1)]:V(e,t)&&n.steps&&(n.steps=nt(n.steps,t),e[s]={...n});}return e},ot=(i,t,e,s)=>{let n=[...i];for(let o=0;o<n.length;o++){let a=n[o];z(a.id,t)?("content"in a&&a.content!==void 0?s?a.content=e:a.content+=e:"output"in a&&a.output!==void 0&&(s?a.output=e:a.output+=e),n[o]={...a}):a.steps&&(a.steps=ot(a.steps,t,e,s),n[o]={...a});}return n};var ee=()=>{let i=useRecoilValue(j),t=useRecoilValue(C),e=useRecoilValue(R),s=useRecoilValue(H),n=useResetRecoilState(E),o=useResetRecoilState(H),a=useResetRecoilState(_),d=useSetRecoilState(L),p=useSetRecoilState(v),h=useSetRecoilState(M),f=useSetRecoilState(w),I=useSetRecoilState(U),g=useSetRecoilState(F),k=useSetRecoilState(D),T=useSetRecoilState(W),$=useSetRecoilState(q),B=useCallback(()=>{t?.socket.emit("clear_session"),t?.socket.disconnect(),$(void 0),o(),d(void 0),h([]),f([]),I([]),g([]),k([]),T(0),n(),a();},[t]),G=useCallback((l,r)=>{h(c=>A(c,l)),t?.socket.emit("ui_message",{message:l,fileReferences:r});},[t?.socket]),K=useCallback(l=>{e&&(h(r=>A(r,l)),e.callback(l));},[e]),Q=useCallback(l=>{t?.socket.emit("chat_settings_change",l);},[t?.socket]),O=useCallback(()=>{p(!1),t?.socket.emit("stop");},[t?.socket]),Z=useCallback(l=>{let r=t?.socket;if(!r)return;let c=new Promise((u,m)=>{r.once("action_response",et=>{et.status?u(et):m(et);});});return r.emit("action_call",l),c},[t?.socket]);return {uploadFile:useCallback((l,r,c)=>l.uploadFile(r,c,s,i),[s,i]),callAction:Z,clear:B,replyMessage:K,sendMessage:G,stopTask:O,setIdToResume:$,updateChatSettings:Q}};var re=()=>{let i=useRecoilValue(M),t=useRecoilValue(L);return {messages:i,firstUserMessage:t}};var fe=()=>{let i=useRecoilValue(H),[t,e]=useRecoilState(C),s=useResetRecoilState(_),n=useSetRecoilState(L),o=useSetRecoilState(v),a=useSetRecoilState(M),d=useSetRecoilState(R),p=useSetRecoilState(w),h=useSetRecoilState(U),f=useSetRecoilState(F),I=useSetRecoilState(D),g=useSetRecoilState(E),k=useSetRecoilState(W),[T,$]=useRecoilState(gt),B=useRecoilValue(q),G=useCallback(({client:O,userEnv:Z,accessToken:tt})=>{let l=vt(O.httpEndpoint,{path:"/ws/socket.io",extraHeaders:{Authorization:tt||"","X-Chainlit-Session-Id":i,"X-Chainlit-Thread-Id":B||"","user-env":JSON.stringify(Z),"X-Chainlit-Chat-Profile":T||""}});e(r=>(r?.socket?.removeAllListeners(),r?.socket?.close(),{socket:l})),l.on("connect",()=>{l.emit("connection_successful"),e(r=>({...r,error:!1}));}),l.on("connect_error",r=>{e(c=>({...c,error:!0}));}),l.on("task_start",()=>{o(!0);}),l.on("task_end",()=>{o(!1);}),l.on("reload",()=>{l.emit("clear_session"),window.location.reload();}),l.on("resume_thread",r=>{let c=[];for(let m of r.steps)c=A(c,m);r.metadata?.chat_profile&&$(r.metadata?.chat_profile),a(c);let u=r.elements||[];h(u.filter(m=>m.type==="avatar")),f(u.filter(m=>m.type==="tasklist")),p(u.filter(m=>["avatar","tasklist"].indexOf(m.type)===-1));}),l.on("new_message",r=>{a(c=>A(c,r));}),l.on("init_thread",r=>{n(r);}),l.on("update_message",r=>{a(c=>N(c,r.id,r));}),l.on("delete_message",r=>{a(c=>nt(c,r.id));}),l.on("stream_start",r=>{a(c=>A(c,r));}),l.on("stream_token",({id:r,token:c,isSequence:u})=>{a(m=>ot(m,r,c,u));}),l.on("ask",({msg:r,spec:c},u)=>{d({spec:c,callback:u}),a(m=>A(m,r)),o(!1);}),l.on("ask_timeout",()=>{d(void 0),o(!1);}),l.on("clear_ask",()=>{d(void 0);}),l.on("chat_settings",r=>{g(r),s();}),l.on("element",r=>{!r.url&&r.chainlitKey&&(r.url=O.getElementUrl(r.chainlitKey,i,tt)),r.type==="avatar"?h(c=>{let u=c.findIndex(m=>m.id===r.id);return u===-1?[...c,r]:[...c.slice(0,u),r,...c.slice(u+1)]}):r.type==="tasklist"?f(c=>{let u=c.findIndex(m=>m.id===r.id);return u===-1?[...c,r]:[...c.slice(0,u),r,...c.slice(u+1)]}):p(c=>{let u=c.findIndex(m=>m.id===r.id);return u===-1?[...c,r]:[...c.slice(0,u),r,...c.slice(u+1)]});}),l.on("remove_element",r=>{p(c=>c.filter(u=>u.id!==r.id)),f(c=>c.filter(u=>u.id!==r.id)),h(c=>c.filter(u=>u.id!==r.id));}),l.on("action",r=>{I(c=>[...c,r]);}),l.on("remove_action",r=>{I(c=>{let u=c.findIndex(m=>m.id===r.id);return u===-1?c:[...c.slice(0,u),...c.slice(u+1)]});}),l.on("token_usage",r=>{k(c=>c+r);});},[e,i,T]),K=useCallback(Dt(G,200),[G]),Q=useCallback(()=>{t?.socket&&(t.socket.removeAllListeners(),t.socket.close());},[t]);return {connect:K,disconnect:Q,chatProfile:T,idToResume:B,setChatProfile:$}};var at="token";function ct(){try{return localStorage.getItem(at)}catch{return}}function Tt(i){try{return localStorage.setItem(at,i)}catch{return}}function Y(){try{return localStorage.removeItem(at)}catch{return}}var wt=async(i,t,e)=>(await i.get(t,e))?.json();function At(i,t,e){let s=useRecoilValue(j);return _t(t?[t,s]:null,([n,o])=>wt(i,n,o),e)}var Ce=i=>{let{data:t,isLoading:e}=At(i,"/auth/config"),[s,n]=useRecoilState(j),o=useSetRecoilState(mt),[a,d]=useRecoilState(ht),p=!!(!e&&t),h=()=>{d(null),Y(),n(""),o(void 0);},f=g=>{if(!g){h();return}try{let{exp:k,...T}=Ut(g);Tt(g),n(`Bearer ${g}`),d(T);}catch(k){console.error("Invalid token, clearing token from local storage","error:",k),h();}};useEffect(()=>{if(!a&&ct()){f(ct());return}},[]);let I=!!s;return t&&!t.requireLogin?{data:t,user:null,isReady:p,isAuthenticated:!0,accessToken:"",logout:()=>{},setAccessToken:()=>{}}:{data:t,user:a,isAuthenticated:I,isReady:p,accessToken:s,logout:h,setAccessToken:f}};var J=class extends Error{constructor(e,s){super(e);this.detail=s;}toString(){return this.detail?`${this.message}: ${this.detail}`:this.message}},lt=class{constructor(t,e,s){this.httpEndpoint=t;this.on401=e;this.onError=s;}buildEndpoint(t){return this.httpEndpoint.endsWith("/")?`${this.httpEndpoint.slice(0,-1)}${t}`:`${this.httpEndpoint}${t}`}checkToken(t){let e="Bearer ";return t.startsWith(e)?t:e+t}async fetch(t,e,s,n,o){try{let a={};s&&(a.Authorization=this.checkToken(s));let d;n instanceof FormData?d=n:(a["Content-Type"]="application/json",d=n?JSON.stringify(n):null);let p=await fetch(this.buildEndpoint(e),{method:t,headers:a,signal:o,body:d});if(!p.ok){let h=await p.json();throw p.status===401&&this.on401&&(Y(),this.on401()),new J(p.statusText,h.detail)}return p}catch(a){throw a instanceof J&&this.onError&&this.onError(a),console.error(a),a}}async get(t,e){return await this.fetch("GET",t,e)}async post(t,e,s,n){return await this.fetch("POST",t,s,e,n)}async put(t,e,s){return await this.fetch("PUT",t,s,e)}async patch(t,e,s){return await this.fetch("PATCH",t,s,e)}async delete(t,e,s){return await this.fetch("DELETE",t,s,e)}},Et=class extends lt{async headerAuth(){return (await this.post("/auth/header",{})).json()}async passwordAuth(t){return (await this.post("/login",t)).json()}async getGeneration(t,e={},s,n,o){let a={userEnv:e};t.type==="CHAT"?a.chatGeneration=t:a.completionGeneration=t;let p=(await this.post("/generation",a,n,s.signal))?.body?.getReader();return new ReadableStream({start(f){function I(){p.read().then(({done:g,value:k})=>{if(g){f.close(),o&&o(g,"");return}let T=new TextDecoder("utf-8").decode(k);o&&o(g,T),f.enqueue(k),I();}).catch(g=>{f.close(),o&&o(!0,""),console.error(g);});}I();}})}async setFeedback(t,e){return (await this.put("/feedback",{feedback:t},e)).json()}async listThreads(t,e,s){return (await this.post("/project/threads",{pagination:t,filter:e},s)).json()}async deleteThread(t,e){return (await this.delete("/project/thread",{threadId:t},e)).json()}uploadFile(t,e,s,n){let o=new XMLHttpRequest,a=new Promise((d,p)=>{let h=new FormData;h.append("file",t),o.open("POST",this.buildEndpoint(`/project/file?session_id=${s}`),!0),n&&o.setRequestHeader("Authorization",this.checkToken(n)),o.upload.onprogress=function(f){if(f.lengthComputable){let I=f.loaded/f.total*100;e(I);}},o.onload=function(){if(o.status===200){let f=JSON.parse(o.responseText);d(f);}else p("Upload failed");},o.onerror=function(){p("Upload error");},o.send(h);});return {xhr:o,promise:a}}getElementUrl(t,e,s){let n="";return s&&(n=`?token=${s}`),this.buildEndpoint(`/project/file/${t}?session_id=${e}${n}`)}getLogoEndpoint(t){return this.buildEndpoint(`/logo?theme=${t}`)}getOAuthEndpoint(t){return this.buildEndpoint(`/auth/oauth/${t}`)}};

export { lt as APIBase, Et as ChainlitAPI, J as ClientError, j as accessTokenState, D as actionState, A as addMessage, It as addMessageToParent, R as askUserState, U as avatarState, gt as chatProfileState, st as chatSettingsDefaultValueSelector, E as chatSettingsInputsState, _ as chatSettingsValueState, nt as deleteMessageById, w as elementState, wt as fetcher, L as firstUserMessageState, V as hasMessageById, Yt as isLastMessage, v as loadingState, M as messagesState, Xt as nestMessages, H as sessionIdState, C as sessionState, F as tasklistState, mt as threadHistoryState, q as threadIdToResumeState, W as tokenCountState, N as updateMessageById, ot as updateMessageContentById, At as useApi, Ce as useAuth, Wt as useChatData, ee as useChatInteract, re as useChatMessages, fe as useChatSession, ht as userState };
//# sourceMappingURL=out.js.map
//# sourceMappingURL=index.mjs.map